<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clody - Firebase 데이터 관리</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .data-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .diary-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .diary-text {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .reply-text {
            color: #666;
            font-style: italic;
        }
        .timestamp {
            color: #999;
            font-size: 0.8em;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background: #fdf2f2;
            border-radius: 5px;
            margin: 10px 0;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            background: #e9ecef;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .ip-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ip-info {
            flex: 1;
        }
        .ip-address {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .ip-details {
            color: #666;
            font-size: 0.9em;
        }
        .ip-actions {
            display: flex;
            gap: 10px;
        }
        .btn-whitelist {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-remove-whitelist {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-view-diaries {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .whitelist-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .limited-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .count-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .period-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .diary-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .diary-number {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .diary-date {
            color: #666;
            font-size: 0.9em;
        }

        .diary-content {
            line-height: 1.6;
        }

        .diary-text, .diary-reply {
            margin-bottom: 10px;
        }

        .diary-text {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }

        .diary-reply {
            background: #f3e5f5;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🍀 Clody Firebase 데이터 관리</h1>
        <p>Firebase Firestore에 저장된 일기 데이터와 IP 제한 현황을 확인할 수 있습니다.</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('diaries')">일기 관리</button>
        <button class="tab" onclick="showTab('ip-limits')">IP 제한 관리</button>
        <button class="tab" onclick="showTab('user-analytics')">활발한 사용자</button>
    </div>

    <!-- 일기 관리 탭 -->
    <div id="diaries-tab" class="tab-content active">
        <button class="refresh-btn" onclick="loadDiaries()">일기 새로고침</button>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-count">-</div>
                <div>총 일기 수</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="today-count">-</div>
                <div>오늘 작성된 일기</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-length">-</div>
                <div>평균 일기 길이</div>
            </div>
        </div>

        <div class="data-container">
            <h2>일기 목록</h2>
            <div id="diary-list">
                <div class="loading">데이터를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <!-- IP 제한 관리 탭 -->
    <div id="ip-limits-tab" class="tab-content">
        <button class="refresh-btn" onclick="loadIPLimits()">IP 현황 새로고침</button>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="limited-ips-count">-</div>
                <div>오늘 제한된 IP</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="whitelist-count">-</div>
                <div>화이트리스트 IP</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-calls-today">-</div>
                <div>오늘 총 호출 수</div>
            </div>
        </div>

        <div class="data-container">
            <h2>제한된 IP 목록 (오늘)</h2>
            <div id="ip-limits-list">
                <div class="loading">IP 제한 현황을 불러오는 중...</div>
            </div>
        </div>

        <div class="data-container">
            <h2>선택된 IP의 일기 목록</h2>
            <div id="ip-diaries-list">
                <div class="loading">IP를 선택하면 해당 IP의 일기 목록이 표시됩니다.</div>
            </div>
        </div>
    </div>

    <!-- 활발한 사용자 분석 탭 -->
    <div id="user-analytics-tab" class="tab-content">
        <button class="refresh-btn" onclick="loadUserAnalytics()">사용자 분석 새로고침</button>

        <div class="stats">
            <div class="stat-item">
                <div>연속 사용자 수</div>
                <div id="active-users-count">0</div>
            </div>
            <div class="stat-item">
                <div>최고 활동 사용자</div>
                <div id="top-user-diaries">0개</div>
            </div>
            <div class="stat-item">
                <div>평균 사용자 일기 수</div>
                <div id="avg-user-diaries">0개</div>
            </div>
        </div>

        <div class="data-container">
            <h2>활발한 사용자 목록 (2개 이상 작성)</h2>
            <div id="active-users-list">
                <div class="loading">사용자 분석을 불러오는 중...</div>
            </div>
        </div>

        <div class="data-container">
            <h2>선택된 사용자의 모든 일기</h2>
            <div id="user-all-diaries">
                <div class="loading">사용자를 선택하면 해당 사용자의 모든 일기가 표시됩니다.</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { 
            collection, 
            getDocs, 
            query, 
            orderBy,
            where,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getTodayLimitedIPs, getDiariesByIP, whitelistIP, removeWhitelistIP, getActiveUserAnalytics, getActiveUsersByPeriod } from "./ip-limit-service.js";

        let diaries = [];
        let limitedIPs = [];
        let selectedIP = null;

        // 탭 전환
        window.showTab = function(tabName) {
            // 모든 탭 비활성화
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 선택된 탭 활성화
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 해당 탭 데이터 로드
            if (tabName === 'diaries') {
                loadDiaries();
            } else if (tabName === 'ip-limits') {
                loadIPLimits();
            } else if (tabName === 'user-analytics') {
                loadUserAnalytics();
            }
        };

        // 일기 데이터 로드
        window.loadDiaries = async function() {
            const diaryList = document.getElementById('diary-list');
            diaryList.innerHTML = '<div class="loading">데이터를 불러오는 중...</div>';

            try {
                const querySnapshot = await getDocs(query(
                    collection(db, "diaries"),
                    orderBy("createdAt", "desc")
                ));

                diaries = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    diaries.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });

                updateDiaryStats();
                displayDiaries();
                
            } catch (error) {
                console.error("데이터 로드 오류:", error);
                diaryList.innerHTML = `<div class="error">데이터를 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        };

        // 일기 통계 업데이트
        function updateDiaryStats() {
            const totalCount = diaries.length;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayCount = diaries.filter(diary => {
                const diaryDate = new Date(diary.createdAt);
                diaryDate.setHours(0, 0, 0, 0);
                return diaryDate.getTime() === today.getTime();
            }).length;

            const avgLength = diaries.length > 0 
                ? Math.round(diaries.reduce((sum, diary) => sum + diary.diary.length, 0) / diaries.length)
                : 0;

            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('avg-length').textContent = avgLength;
        }

        // 일기 목록 표시
        function displayDiaries() {
            const diaryList = document.getElementById('diary-list');
            
            if (diaries.length === 0) {
                diaryList.innerHTML = '<div class="loading">저장된 일기가 없습니다.</div>';
                return;
            }

            const diaryHTML = diaries.map(diary => `
                <div class="diary-item">
                    <div class="diary-text">📝 ${diary.diary}</div>
                    <div class="reply-text">💬 ${diary.reply}</div>
                    <div class="timestamp">
                        작성일: ${diary.createdAt.toLocaleString('ko-KR')}
                        ${diary.userIP ? `| IP: ${diary.userIP}` : ''}
                    </div>
                </div>
            `).join('');

            diaryList.innerHTML = diaryHTML;
        }

        // IP 제한 현황 로드
        window.loadIPLimits = async function() {
            const ipLimitsList = document.getElementById('ip-limits-list');
            ipLimitsList.innerHTML = '<div class="loading">IP 제한 현황을 불러오는 중...</div>';

            try {
                limitedIPs = await getTodayLimitedIPs();
                updateIPStats();
                displayIPLimits();
                
            } catch (error) {
                console.error("IP 제한 현황 로드 오류:", error);
                ipLimitsList.innerHTML = `<div class="error">IP 제한 현황을 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        };

        // IP 통계 업데이트
        function updateIPStats() {
            const limitedCount = limitedIPs.filter(ip => !ip.whitelist).length;
            const whitelistCount = limitedIPs.filter(ip => ip.whitelist).length;
            const totalCalls = limitedIPs.reduce((sum, ip) => sum + ip.count, 0);

            document.getElementById('limited-ips-count').textContent = limitedCount;
            document.getElementById('whitelist-count').textContent = whitelistCount;
            document.getElementById('total-calls-today').textContent = totalCalls;
        }

        // IP 제한 목록 표시
        function displayIPLimits() {
            const ipLimitsList = document.getElementById('ip-limits-list');
            
            if (limitedIPs.length === 0) {
                ipLimitsList.innerHTML = '<div class="loading">오늘 제한된 IP가 없습니다.</div>';
                return;
            }

            const ipHTML = limitedIPs.map(ip => `
                <div class="ip-item">
                    <div class="ip-info">
                        <div class="ip-address">
                            🌐 ${ip.ip}
                            ${ip.whitelist ? '<span class="whitelist-badge">화이트리스트</span>' : '<span class="limited-badge">제한됨</span>'}
                        </div>
                        <div class="ip-details">
                            호출 횟수: ${ip.count}회 | 마지막 호출: ${ip.lastCalled ? ip.lastCalled.toLocaleString('ko-KR') : '알 수 없음'}
                        </div>
                    </div>
                    <div class="ip-actions">
                        <button class="btn-view-diaries" onclick="viewIPDiaries('${ip.ip}')">일기 보기</button>
                        ${ip.whitelist ? 
                            `<button class="btn-remove-whitelist" onclick="removeFromWhitelist('${ip.ip}')">화이트리스트 해제</button>` :
                            `<button class="btn-whitelist" onclick="addToWhitelist('${ip.ip}')">화이트리스트 추가</button>`
                        }
                    </div>
                </div>
            `).join('');

            ipLimitsList.innerHTML = ipHTML;
        }

        // 특정 IP의 일기 보기
        window.viewIPDiaries = async function(ip) {
            selectedIP = ip;
            const ipDiariesList = document.getElementById('ip-diaries-list');
            ipDiariesList.innerHTML = '<div class="loading">해당 IP의 일기를 불러오는 중...</div>';

            try {
                const ipDiaries = await getDiariesByIP(ip);
                
                if (ipDiaries.length === 0) {
                    ipDiariesList.innerHTML = `<div class="loading">IP ${ip}로 작성된 일기가 없습니다.</div>`;
                    return;
                }

                const diariesHTML = ipDiaries.map(diary => `
                    <div class="diary-item">
                        <div class="diary-text">📝 ${diary.diary}</div>
                        <div class="reply-text">💬 ${diary.reply}</div>
                        <div class="timestamp">작성일: ${diary.createdAt.toLocaleString('ko-KR')}</div>
                    </div>
                `).join('');

                ipDiariesList.innerHTML = `
                    <h3>IP ${ip}의 일기 목록 (${ipDiaries.length}개)</h3>
                    ${diariesHTML}
                `;
                
            } catch (error) {
                console.error("IP별 일기 조회 오류:", error);
                ipDiariesList.innerHTML = `<div class="error">일기를 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        };

        // 화이트리스트 추가
        window.addToWhitelist = async function(ip) {
            if (!confirm(`IP ${ip}를 화이트리스트에 추가하시겠습니까?`)) {
                return;
            }

            try {
                const result = await whitelistIP(ip);
                if (result.success) {
                    alert(`IP ${ip}가 화이트리스트에 추가되었습니다.`);
                    loadIPLimits(); // 목록 새로고침
                } else {
                    alert(`오류가 발생했습니다: ${result.error}`);
                }
            } catch (error) {
                console.error("화이트리스트 추가 오류:", error);
                alert(`오류가 발생했습니다: ${error.message}`);
            }
        };

        // 화이트리스트 해제
        window.removeFromWhitelist = async function(ip) {
            if (!confirm(`IP ${ip}를 화이트리스트에서 해제하시겠습니까?`)) {
                return;
            }

            try {
                const result = await removeWhitelistIP(ip);
                if (result.success) {
                    alert(`IP ${ip}가 화이트리스트에서 해제되었습니다.`);
                    loadIPLimits(); // 목록 새로고침
                } else {
                    alert(`오류가 발생했습니다: ${result.error}`);
                }
            } catch (error) {
                console.error("화이트리스트 해제 오류:", error);
                alert(`오류가 발생했습니다: ${error.message}`);
            }
        };

        // 사용자 분석 데이터 로드
        window.loadUserAnalytics = async function() {
            try {
                const activeUsers = await getActiveUserAnalytics();
                
                // 통계 업데이트
                document.getElementById('active-users-count').textContent = activeUsers.length;
                document.getElementById('top-user-diaries').textContent = 
                    activeUsers.length > 0 ? `${activeUsers[0].totalDiaries}개` : '0개';
                
                const avgDiaries = activeUsers.length > 0 
                    ? Math.round(activeUsers.reduce((sum, user) => sum + user.totalDiaries, 0) / activeUsers.length)
                    : 0;
                document.getElementById('avg-user-diaries').textContent = `${avgDiaries}개`;
                
                // 활발한 사용자 목록 표시
                displayActiveUsers(activeUsers);
            } catch (error) {
                console.error("사용자 분석 로드 오류:", error);
                document.getElementById('active-users-list').innerHTML = 
                    `<div class="error">사용자 분석을 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        };

        // 활발한 사용자 목록 표시
        function displayActiveUsers(users) {
            const usersList = document.getElementById('active-users-list');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="loading">활발한 사용자가 없습니다.</div>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const firstDiary = user.firstDiary ? user.firstDiary.toLocaleString('ko-KR') : '알 수 없음';
                const lastDiary = user.lastDiary ? user.lastDiary.toLocaleString('ko-KR') : '알 수 없음';
                const daysDiff = user.firstDiary && user.lastDiary 
                    ? Math.ceil((user.lastDiary - user.firstDiary) / (1000 * 60 * 60 * 24)) + 1
                    : 1;
                
                html += `
                    <div class="ip-item">
                        <div class="ip-info">
                            <strong>IP: ${user.ip}</strong>
                            <span class="count-badge">${user.totalDiaries}개 일기</span>
                            <span class="period-badge">${daysDiff}일간 활동</span>
                        </div>
                        <div class="ip-details">
                            <div>첫 일기: ${firstDiary}</div>
                            <div>마지막 일기: ${lastDiary}</div>
                        </div>
                        <div class="ip-actions">
                            <button class="btn-view-diaries" onclick="viewUserAllDiaries('${user.ip}', ${user.totalDiaries})">
                                모든 일기 보기 (${user.totalDiaries}개)
                            </button>
                        </div>
                    </div>
                `;
            });

            usersList.innerHTML = html;
        }

        // 특정 사용자의 모든 일기 보기
        window.viewUserAllDiaries = async function(ip, totalCount) {
            const userAllDiaries = document.getElementById('user-all-diaries');
            userAllDiaries.innerHTML = `<div class="loading">IP ${ip}의 모든 일기를 불러오는 중...</div>`;

            try {
                const userDiaries = await getDiariesByIP(ip);
                
                if (userDiaries.length === 0) {
                    userAllDiaries.innerHTML = `<div class="loading">IP ${ip}의 일기가 없습니다.</div>`;
                    return;
                }

                let html = `<h3>IP ${ip}의 모든 일기 (${userDiaries.length}개)</h3>`;
                
                userDiaries.forEach((diary, index) => {
                    const date = diary.createdAt ? diary.createdAt.toLocaleString('ko-KR') : '알 수 없음';
                    html += `
                        <div class="diary-item">
                            <div class="diary-header">
                                <span class="diary-number">#${index + 1}</span>
                                <span class="diary-date">${date}</span>
                            </div>
                            <div class="diary-content">
                                <div class="diary-text">
                                    <strong>일기:</strong> ${diary.diary}
                                </div>
                                <div class="diary-reply">
                                    <strong>응답:</strong> ${diary.reply}
                                </div>
                            </div>
                        </div>
                    `;
                });

                userAllDiaries.innerHTML = html;
            } catch (error) {
                console.error("사용자 일기 조회 오류:", error);
                userAllDiaries.innerHTML = `<div class="error">일기를 불러오는 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        };

        // 페이지 로드 시 일기 데이터 불러오기
        loadDiaries();
    </script>
</body>
</html> 