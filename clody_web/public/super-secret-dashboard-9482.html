<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clody - Firebase ë°ì´í„° ê´€ë¦¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .data-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .diary-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .diary-text {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .reply-text {
            color: #666;
            font-style: italic;
        }
        .timestamp {
            color: #999;
            font-size: 0.8em;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background: #fdf2f2;
            border-radius: 5px;
            margin: 10px 0;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .refresh-btn:hover {
            background: #0056b3;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            background: #e9ecef;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .ip-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ip-info {
            flex: 1;
        }
        .ip-address {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .ip-details {
            color: #666;
            font-size: 0.9em;
        }
        .ip-actions {
            display: flex;
            gap: 10px;
        }
        .btn-whitelist {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-remove-whitelist {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-view-diaries {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .whitelist-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .limited-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .count-badge {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .period-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .diary-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .diary-number {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .diary-date {
            color: #666;
            font-size: 0.9em;
        }

        .diary-content {
            line-height: 1.6;
        }

        .diary-text, .diary-reply {
            margin-bottom: 10px;
        }

        .diary-text {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
        }

        .diary-reply {
            background: #f3e5f5;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ€ Clody Firebase ë°ì´í„° ê´€ë¦¬</h1>
        <p>Firebase Firestoreì— ì €ì¥ëœ ì¼ê¸° ë°ì´í„°ì™€ IP ì œí•œ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('diaries')">ì¼ê¸° ê´€ë¦¬</button>
        <button class="tab" onclick="showTab('ip-limits')">IP ì œí•œ ê´€ë¦¬</button>
        <button class="tab" onclick="showTab('user-analytics')">í™œë°œí•œ ì‚¬ìš©ì</button>
        <button class="tab" onclick="showTab('daily-stats')">ë‚ ì§œë³„ í†µê³„</button>
    </div>

    <!-- ì¼ê¸° ê´€ë¦¬ íƒ­ -->
    <div id="diaries-tab" class="tab-content active">
        <button class="refresh-btn" onclick="loadDiaries()">ì¼ê¸° ìƒˆë¡œê³ ì¹¨</button>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-count">-</div>
                <div>ì´ ì¼ê¸° ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="today-count">-</div>
                <div>ì˜¤ëŠ˜ ì‘ì„±ëœ ì¼ê¸°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-length">-</div>
                <div>í‰ê·  ì¼ê¸° ê¸¸ì´</div>
            </div>
        </div>

        <div class="data-container">
            <h2>ì¼ê¸° ëª©ë¡</h2>
            <div id="diary-list">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <!-- IP ì œí•œ ê´€ë¦¬ íƒ­ -->
    <div id="ip-limits-tab" class="tab-content">
        <button class="refresh-btn" onclick="loadIPLimits()">IP í˜„í™© ìƒˆë¡œê³ ì¹¨</button>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="limited-ips-count">-</div>
                <div>ì˜¤ëŠ˜ ì œí•œëœ IP</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="whitelist-count">-</div>
                <div>í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ IP</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-calls-today">-</div>
                <div>ì˜¤ëŠ˜ ì´ í˜¸ì¶œ ìˆ˜</div>
            </div>
        </div>

        <div class="data-container">
            <h2>ì œí•œëœ IP ëª©ë¡ (ì˜¤ëŠ˜)</h2>
            <div id="ip-limits-list">
                <div class="loading">IP ì œí•œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <div class="data-container">
            <h2>ì„ íƒëœ IPì˜ ì¼ê¸° ëª©ë¡</h2>
            <div id="ip-diaries-list">
                <div class="loading">IPë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ IPì˜ ì¼ê¸° ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- í™œë°œí•œ ì‚¬ìš©ì ë¶„ì„ íƒ­ -->
    <div id="user-analytics-tab" class="tab-content">
        <button class="refresh-btn" onclick="loadUserAnalytics()">ì‚¬ìš©ì ë¶„ì„ ìƒˆë¡œê³ ì¹¨</button>

        <div class="stats">
            <div class="stat-item">
                <div>ì—°ì† ì‚¬ìš©ì ìˆ˜</div>
                <div id="active-users-count">0</div>
            </div>
            <div class="stat-item">
                <div>ìµœê³  í™œë™ ì‚¬ìš©ì</div>
                <div id="top-user-diaries">0ê°œ</div>
            </div>
            <div class="stat-item">
                <div>í‰ê·  ì‚¬ìš©ì ì¼ê¸° ìˆ˜</div>
                <div id="avg-user-diaries">0ê°œ</div>
            </div>
        </div>

        <div class="data-container">
            <h2>í™œë°œí•œ ì‚¬ìš©ì ëª©ë¡ (2ê°œ ì´ìƒ ì‘ì„±)</h2>
            <div id="active-users-list">
                <div class="loading">ì‚¬ìš©ì ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <div class="data-container">
            <h2>ì„ íƒëœ ì‚¬ìš©ìì˜ ëª¨ë“  ì¼ê¸°</h2>
            <div id="user-all-diaries">
                <div class="loading">ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  ì¼ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- ë‚ ì§œë³„ í†µê³„ íƒ­ -->
    <div id="daily-stats-tab" class="tab-content">
        <button class="refresh-btn" onclick="loadDailyStats()">í†µê³„ ìƒˆë¡œê³ ì¹¨</button>
        
        <div class="data-container">
            <h2>ë‚ ì§œë³„ ì¼ê¸° ì‘ì„± í†µê³„</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-days">-</div>
                    <div>ì´ í™œë™ ì¼ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avg-daily">-</div>
                    <div>ì¼í‰ê·  ì¼ê¸° ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="max-daily">-</div>
                    <div>ìµœëŒ€ ì¼ì¼ ì¼ê¸° ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recent-7days">-</div>
                    <div>ìµœê·¼ 7ì¼ ì¼ê¸° ìˆ˜</div>
                </div>
            </div>
        </div>

        <div class="data-container">
            <h2>ë‚ ì§œë³„ ìƒì„¸ í†µê³„</h2>
            <div style="margin-bottom: 20px;">
                <label for="date-range">ê¸°ê°„ ì„ íƒ: </label>
                <select id="date-range" onchange="loadDailyStats()">
                    <option value="7">ìµœê·¼ 7ì¼</option>
                    <option value="30">ìµœê·¼ 30ì¼</option>
                    <option value="90">ìµœê·¼ 90ì¼</option>
                    <option value="all">ì „ì²´ ê¸°ê°„</option>
                </select>
            </div>
            <div id="daily-stats-list">
                <div class="loading">ë‚ ì§œë³„ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from "./firebase-config.js";
        import { 
            collection, 
            getDocs, 
            query, 
            orderBy,
            where,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getTodayLimitedIPs, getDiariesByIP, whitelistIP, removeWhitelistIP, getActiveUserAnalytics, getActiveUsersByPeriod } from "./ip-limit-service.js";

        let diaries = [];
        let limitedIPs = [];
        let selectedIP = null;

        // íƒ­ ì „í™˜
        window.showTab = function(tabName) {
            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // í•´ë‹¹ íƒ­ ë°ì´í„° ë¡œë“œ
            if (tabName === 'diaries') {
                loadDiaries();
            } else if (tabName === 'ip-limits') {
                loadIPLimits();
            } else if (tabName === 'user-analytics') {
                loadUserAnalytics();
            } else if (tabName === 'daily-stats') {
                loadDailyStats();
            }
        };

        // ì¼ê¸° ë°ì´í„° ë¡œë“œ
        window.loadDiaries = async function() {
            const diaryList = document.getElementById('diary-list');
            diaryList.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const querySnapshot = await getDocs(query(
                    collection(db, "diaries"),
                    orderBy("createdAt", "desc")
                ));

                diaries = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    diaries.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });

                updateDiaryStats();
                displayDiaries();
                
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                diaryList.innerHTML = `<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // ì¼ê¸° í†µê³„ ì—…ë°ì´íŠ¸
        function updateDiaryStats() {
            const totalCount = diaries.length;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayCount = diaries.filter(diary => {
                const diaryDate = new Date(diary.createdAt);
                diaryDate.setHours(0, 0, 0, 0);
                return diaryDate.getTime() === today.getTime();
            }).length;

            const avgLength = diaries.length > 0 
                ? Math.round(diaries.reduce((sum, diary) => sum + diary.diary.length, 0) / diaries.length)
                : 0;

            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('today-count').textContent = todayCount;
            document.getElementById('avg-length').textContent = avgLength;
        }

        // ì¼ê¸° ëª©ë¡ í‘œì‹œ
        function displayDiaries() {
            const diaryList = document.getElementById('diary-list');
            
            if (diaries.length === 0) {
                diaryList.innerHTML = '<div class="loading">ì €ì¥ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const diaryHTML = diaries.map(diary => `
                <div class="diary-item" data-diary-id="${diary.id}">
                    <div class="diary-text">ğŸ“ ${diary.diary}</div>
                    <div class="reply-text">ğŸ’¬ ${diary.reply}</div>
                    <div class="timestamp">
                        ì‘ì„±ì¼: ${diary.createdAt.toLocaleString('ko-KR')}
                        ${diary.userIP ? `| IP: ${diary.userIP}` : ''}
                    </div>
                </div>
            `).join('');

            diaryList.innerHTML = diaryHTML;
        }

        // IP ì œí•œ í˜„í™© ë¡œë“œ
        window.loadIPLimits = async function() {
            const ipLimitsList = document.getElementById('ip-limits-list');
            ipLimitsList.innerHTML = '<div class="loading">IP ì œí•œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                limitedIPs = await getTodayLimitedIPs();
                updateIPStats();
                displayIPLimits();
                
            } catch (error) {
                console.error("IP ì œí•œ í˜„í™© ë¡œë“œ ì˜¤ë¥˜:", error);
                ipLimitsList.innerHTML = `<div class="error">IP ì œí•œ í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // IP í†µê³„ ì—…ë°ì´íŠ¸
        function updateIPStats() {
            const limitedCount = limitedIPs.filter(ip => !ip.whitelist).length;
            const whitelistCount = limitedIPs.filter(ip => ip.whitelist).length;
            const totalCalls = limitedIPs.reduce((sum, ip) => sum + ip.count, 0);

            document.getElementById('limited-ips-count').textContent = limitedCount;
            document.getElementById('whitelist-count').textContent = whitelistCount;
            document.getElementById('total-calls-today').textContent = totalCalls;
        }

        // IP ì œí•œ ëª©ë¡ í‘œì‹œ
        function displayIPLimits() {
            const ipLimitsList = document.getElementById('ip-limits-list');
            
            if (limitedIPs.length === 0) {
                ipLimitsList.innerHTML = '<div class="loading">ì˜¤ëŠ˜ ì œí•œëœ IPê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const ipHTML = limitedIPs.map(ip => `
                <div class="ip-item">
                    <div class="ip-info">
                        <div class="ip-address">
                            ğŸŒ ${ip.ip}
                            ${ip.whitelist ? '<span class="whitelist-badge">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸</span>' : '<span class="limited-badge">ì œí•œë¨</span>'}
                        </div>
                        <div class="ip-details">
                            í˜¸ì¶œ íšŸìˆ˜: ${ip.count}íšŒ | ë§ˆì§€ë§‰ í˜¸ì¶œ: ${ip.lastCalled ? ip.lastCalled.toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ'}
                        </div>
                    </div>
                    <div class="ip-actions">
                        <button class="btn-view-diaries" onclick="viewIPDiaries('${ip.ip}')">ì¼ê¸° ë³´ê¸°</button>
                        ${ip.whitelist ? 
                            `<button class="btn-remove-whitelist" onclick="removeFromWhitelist('${ip.ip}')">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í•´ì œ</button>` :
                            `<button class="btn-whitelist" onclick="addToWhitelist('${ip.ip}')">í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button>`
                        }
                    </div>
                </div>
            `).join('');

            ipLimitsList.innerHTML = ipHTML;
        }

        // íŠ¹ì • IPì˜ ì¼ê¸° ë³´ê¸°
        window.viewIPDiaries = async function(ip) {
            selectedIP = ip;
            const ipDiariesList = document.getElementById('ip-diaries-list');
            ipDiariesList.innerHTML = '<div class="loading">í•´ë‹¹ IPì˜ ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const ipDiaries = await getDiariesByIP(ip);
                
                if (ipDiaries.length === 0) {
                    ipDiariesList.innerHTML = `<div class="loading">IP ${ip}ë¡œ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }

                const diariesHTML = ipDiaries.map(diary => `
                    <div class="diary-item">
                        <div class="diary-text">ğŸ“ ${diary.diary}</div>
                        <div class="reply-text">ğŸ’¬ ${diary.reply}</div>
                        <div class="timestamp">ì‘ì„±ì¼: ${diary.createdAt.toLocaleString('ko-KR')}</div>
                    </div>
                `).join('');

                ipDiariesList.innerHTML = `
                    <h3>IP ${ip}ì˜ ì¼ê¸° ëª©ë¡ (${ipDiaries.length}ê°œ)</h3>
                    ${diariesHTML}
                `;
                
            } catch (error) {
                console.error("IPë³„ ì¼ê¸° ì¡°íšŒ ì˜¤ë¥˜:", error);
                ipDiariesList.innerHTML = `<div class="error">ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
        window.addToWhitelist = async function(ip) {
            if (!confirm(`IP ${ip}ë¥¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const result = await whitelistIP(ip);
                if (result.success) {
                    alert(`IP ${ip}ê°€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadIPLimits(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${result.error}`);
                }
            } catch (error) {
                console.error("í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ì˜¤ë¥˜:", error);
                alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        };

        // í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í•´ì œ
        window.removeFromWhitelist = async function(ip) {
            if (!confirm(`IP ${ip}ë¥¼ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const result = await removeWhitelistIP(ip);
                if (result.success) {
                    alert(`IP ${ip}ê°€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    loadIPLimits(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${result.error}`);
                }
            } catch (error) {
                console.error("í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ í•´ì œ ì˜¤ë¥˜:", error);
                alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        };

        // ì‚¬ìš©ì ë¶„ì„ ë°ì´í„° ë¡œë“œ
        window.loadUserAnalytics = async function() {
            try {
                const activeUsers = await getActiveUserAnalytics();
                
                // í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('active-users-count').textContent = activeUsers.length;
                document.getElementById('top-user-diaries').textContent = 
                    activeUsers.length > 0 ? `${activeUsers[0].totalDiaries}ê°œ` : '0ê°œ';
                
                const avgDiaries = activeUsers.length > 0 
                    ? Math.round(activeUsers.reduce((sum, user) => sum + user.totalDiaries, 0) / activeUsers.length)
                    : 0;
                document.getElementById('avg-user-diaries').textContent = `${avgDiaries}ê°œ`;
                
                // í™œë°œí•œ ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
                displayActiveUsers(activeUsers);
            } catch (error) {
                console.error("ì‚¬ìš©ì ë¶„ì„ ë¡œë“œ ì˜¤ë¥˜:", error);
                document.getElementById('active-users-list').innerHTML = 
                    `<div class="error">ì‚¬ìš©ì ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // í™œë°œí•œ ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
        function displayActiveUsers(users) {
            const usersList = document.getElementById('active-users-list');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="loading">í™œë°œí•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '';
            users.forEach(user => {
                const firstDiary = user.firstDiary ? user.firstDiary.toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const lastDiary = user.lastDiary ? user.lastDiary.toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                const daysDiff = user.firstDiary && user.lastDiary 
                    ? Math.ceil((user.lastDiary - user.firstDiary) / (1000 * 60 * 60 * 24)) + 1
                    : 1;
                
                html += `
                    <div class="ip-item">
                        <div class="ip-info">
                            <strong>IP: ${user.ip}</strong>
                            <span class="count-badge">${user.totalDiaries}ê°œ ì¼ê¸°</span>
                            <span class="period-badge">${daysDiff}ì¼ê°„ í™œë™</span>
                        </div>
                        <div class="ip-details">
                            <div>ì²« ì¼ê¸°: ${firstDiary}</div>
                            <div>ë§ˆì§€ë§‰ ì¼ê¸°: ${lastDiary}</div>
                        </div>
                        <div class="ip-actions">
                            <button class="btn-view-diaries" onclick="viewUserAllDiaries('${user.ip}', ${user.totalDiaries})">
                                ëª¨ë“  ì¼ê¸° ë³´ê¸° (${user.totalDiaries}ê°œ)
                            </button>
                        </div>
                    </div>
                `;
            });

            usersList.innerHTML = html;
        }

        // íŠ¹ì • ì‚¬ìš©ìì˜ ëª¨ë“  ì¼ê¸° ë³´ê¸°
        window.viewUserAllDiaries = async function(ip, totalCount) {
            const userAllDiaries = document.getElementById('user-all-diaries');
            userAllDiaries.innerHTML = `<div class="loading">IP ${ip}ì˜ ëª¨ë“  ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>`;

            try {
                const userDiaries = await getDiariesByIP(ip);
                
                if (userDiaries.length === 0) {
                    userAllDiaries.innerHTML = `<div class="loading">IP ${ip}ì˜ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }

                let html = `<h3>IP ${ip}ì˜ ëª¨ë“  ì¼ê¸° (${userDiaries.length}ê°œ)</h3>`;
                
                userDiaries.forEach((diary, index) => {
                    const date = diary.createdAt ? diary.createdAt.toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                    html += `
                        <div class="diary-item">
                            <div class="diary-header">
                                <span class="diary-number">#${index + 1}</span>
                                <span class="diary-date">${date}</span>
                            </div>
                            <div class="diary-content">
                                <div class="diary-text">
                                    <strong>ì¼ê¸°:</strong> ${diary.diary}
                                </div>
                                <div class="diary-reply">
                                    <strong>ì‘ë‹µ:</strong> ${diary.reply}
                                </div>
                            </div>
                        </div>
                    `;
                });

                userAllDiaries.innerHTML = html;
            } catch (error) {
                console.error("ì‚¬ìš©ì ì¼ê¸° ì¡°íšŒ ì˜¤ë¥˜:", error);
                userAllDiaries.innerHTML = `<div class="error">ì¼ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // ë‚ ì§œë³„ í†µê³„ ë¡œë“œ
        window.loadDailyStats = async function() {
            const dailyStatsList = document.getElementById('daily-stats-list');
            const dateRange = document.getElementById('date-range').value;
            
            dailyStatsList.innerHTML = '<div class="loading">ë‚ ì§œë³„ í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const querySnapshot = await getDocs(query(
                    collection(db, "diaries"),
                    orderBy("createdAt", "desc")
                ));

                const diaryData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.createdAt) {
                        diaryData.push({
                            id: doc.id,
                            date: data.createdAt.toDate(),
                            ...data
                        });
                    }
                });

                // ë‚ ì§œë³„ ê·¸ë£¹í™”
                const dailyStats = {};
                const now = new Date();
                
                diaryData.forEach(diary => {
                    const dateKey = diary.date.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                    
                    // ê¸°ê°„ í•„í„°ë§
                    if (dateRange !== 'all') {
                        const daysDiff = Math.floor((now - diary.date) / (1000 * 60 * 60 * 24));
                        if (daysDiff >= parseInt(dateRange)) return;
                    }
                    
                    if (!dailyStats[dateKey]) {
                        dailyStats[dateKey] = {
                            date: dateKey,
                            count: 0,
                            diaries: []
                        };
                    }
                    dailyStats[dateKey].count++;
                    dailyStats[dateKey].diaries.push(diary);
                });

                // í†µê³„ ê³„ì‚°
                const dates = Object.keys(dailyStats).sort().reverse();
                const totalDays = dates.length;
                const totalDiaries = diaryData.length;
                const avgDaily = totalDays > 0 ? (totalDiaries / totalDays).toFixed(1) : 0;
                const maxDaily = Math.max(...Object.values(dailyStats).map(stat => stat.count), 0);
                
                // ìµœê·¼ 7ì¼ ì¼ê¸° ìˆ˜ ê³„ì‚°
                const recent7Days = diaryData.filter(diary => {
                    const daysDiff = Math.floor((now - diary.date) / (1000 * 60 * 60 * 24));
                    return daysDiff < 7;
                }).length;

                // ìƒë‹¨ í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('total-days').textContent = totalDays;
                document.getElementById('avg-daily').textContent = avgDaily;
                document.getElementById('max-daily').textContent = maxDaily;
                document.getElementById('recent-7days').textContent = recent7Days;

                // ë‚ ì§œë³„ ë¦¬ìŠ¤íŠ¸ ìƒì„±
                let html = '';
                if (dates.length === 0) {
                    html = '<div class="loading">ì„ íƒí•œ ê¸°ê°„ì— ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    dates.forEach(dateKey => {
                        const stat = dailyStats[dateKey];
                        const dateObj = new Date(dateKey);
                        const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dateObj.getDay()];
                        const formattedDate = `${dateObj.getFullYear()}ë…„ ${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼ (${dayOfWeek})`;
                        
                        html += `
                            <div class="diary-item">
                                <div class="diary-header">
                                    <strong>${formattedDate}</strong>
                                    <span class="diary-count" style="background: #007bff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${stat.count}ê°œ</span>
                                </div>
                                <div class="diary-details" style="margin-top: 10px; font-size: 14px; color: #666;">
                                    ${stat.diaries.map(diary => {
                                        const time = diary.date.toLocaleTimeString('ko-KR', { 
                                            hour: '2-digit', 
                                            minute: '2-digit' 
                                        });
                                        return `<div class="diary-link" onclick="goToDiary('${diary.id}')" style="margin: 5px 0; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='transparent'">â€¢ ${time} - ${diary.diary.substring(0, 50)}${diary.diary.length > 50 ? '...' : ''}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    });
                }

                dailyStatsList.innerHTML = html;

            } catch (error) {
                console.error("ë‚ ì§œë³„ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:", error);
                dailyStatsList.innerHTML = `<div class="error">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        };

        // ë‚ ì§œë³„ í†µê³„ì—ì„œ ì¼ê¸° í´ë¦­ ì‹œ ì¼ê¸°ê´€ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™
        window.goToDiary = function(diaryId) {
            // ì¼ê¸°ê´€ë¦¬ íƒ­ìœ¼ë¡œ ì „í™˜
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ì¼ê¸°ê´€ë¦¬ íƒ­ í™œì„±í™”
            document.querySelector('.tab[onclick="showTab(\'diaries\')"]').classList.add('active');
            document.getElementById('diaries-tab').classList.add('active');
            
            // ì¼ê¸° ë°ì´í„° ë¡œë“œ
            loadDiaries().then(() => {
                // í•´ë‹¹ ì¼ê¸° í•˜ì´ë¼ì´íŠ¸
                setTimeout(() => {
                    const diaryElement = document.querySelector(`[data-diary-id="${diaryId}"]`);
                    if (diaryElement) {
                        // í•´ë‹¹ ì¼ê¸°ë¡œ ìŠ¤í¬ë¡¤
                        diaryElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
                        diaryElement.style.backgroundColor = '#fff3cd';
                        diaryElement.style.border = '2px solid #ffc107';
                        diaryElement.style.transition = 'all 0.3s ease';
                        
                        // 3ì´ˆ í›„ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                        setTimeout(() => {
                            diaryElement.style.backgroundColor = '';
                            diaryElement.style.border = '1px solid #ddd';
                        }, 3000);
                    }
                }, 100);
            });
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¼ê¸° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        loadDiaries();
    </script>
</body>
</html> 